<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sannsvar - Configuration</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .provider-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }
    .provider-card {
      border: 2px solid #333;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      transition: border-color 0.2s;
    }
    .provider-card.connected {
      border-color: #4caf50;
      background: rgba(76, 175, 80, 0.1);
    }
    .provider-card h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.1rem;
    }
    .provider-card p {
      font-size: 0.85rem;
      color: #888;
      margin: 0.5rem 0;
    }
    .provider-card .btn {
      margin-top: 0.5rem;
      width: 100%;
    }
    .provider-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      color: #4caf50;
      font-weight: bold;
    }
    .provider-status .icon {
      font-size: 1.2rem;
    }
    .or-divider {
      text-align: center;
      margin: 1.5rem 0;
      color: #666;
    }
    .or-divider span {
      background: #1a1a2e;
      padding: 0 1rem;
    }
    .or-divider::before {
      content: '';
      display: block;
      border-top: 1px solid #333;
      margin-bottom: -0.7rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Sannsvar</h1>
      <p class="subtitle">Psychographic Recommendations for Stremio</p>
    </header>

    <!-- Step 1: Trakt.tv Authorization -->
    <section id="step1" class="step active">
      <div class="step-header">
        <span class="step-number">1</span>
        <h2>Connect to Trakt.tv</h2>
      </div>
      <p class="step-description">
        We use your Trakt.tv watch history to understand your viewing patterns.
        This enables personalized recommendations based on your actual preferences.
      </p>

      <div id="trakt-connect">
        <button id="btn-start-trakt" class="btn primary">
          Connect Trakt.tv Account
        </button>
        <button id="btn-skip-trakt" class="btn secondary" style="margin-left: 1rem;">
          Skip (use without history)
        </button>
      </div>

      <div id="trakt-auth" class="hidden">
        <div class="auth-code-display">
          <p>Go to <a href="https://trakt.tv/activate" target="_blank" rel="noopener">trakt.tv/activate</a> and enter:</p>
          <div class="code-box">
            <span id="user-code">----</span>
          </div>
          <p class="hint">Waiting for authorization...</p>
          <div class="spinner"></div>
        </div>
      </div>

      <div id="trakt-success" class="hidden">
        <div class="success-message">
          <span class="icon">&#10003;</span>
          <span>Connected as <strong id="trakt-username">username</strong></span>
        </div>
      </div>
    </section>

    <!-- Step 2: AI Provider OAuth -->
    <section id="step2" class="step">
      <div class="step-header">
        <span class="step-number">2</span>
        <h2>Connect AI Providers</h2>
      </div>
      <p class="step-description">
        Login with your existing AI subscriptions. Your subscription covers the usage - no extra API costs!
        Connect multiple providers for faster loading across categories.
      </p>

      <div class="provider-grid">
        <!-- Google / Gemini -->
        <div id="google-card" class="provider-card">
          <h3>Google Gemini</h3>
          <p>Uses your Gemini Advanced / AI Pro subscription</p>
          <div id="google-connect">
            <button id="btn-google-login" class="btn primary">
              Login with Google
            </button>
          </div>
          <div id="google-success" class="hidden">
            <div class="provider-status">
              <span class="icon">&#10003;</span>
              <span id="google-email">Connected</span>
            </div>
          </div>
        </div>

        <!-- OpenAI / ChatGPT -->
        <div id="openai-card" class="provider-card">
          <h3>OpenAI ChatGPT</h3>
          <p>Uses your ChatGPT Plus/Pro subscription</p>
          <div id="openai-connect">
            <button id="btn-openai-login" class="btn primary">
              Login with OpenAI
            </button>
          </div>
          <div id="openai-success" class="hidden">
            <div class="provider-status">
              <span class="icon">&#10003;</span>
              <span id="openai-email">Connected</span>
            </div>
          </div>
        </div>

        <!-- Claude -->
        <div id="claude-card" class="provider-card">
          <h3>Anthropic Claude</h3>
          <p>Uses your Claude Pro/Max subscription</p>
          <div id="claude-connect">
            <button id="btn-claude-login" class="btn primary">
              Login with Claude
            </button>
          </div>
          <div id="claude-success" class="hidden">
            <div class="provider-status">
              <span class="icon">&#10003;</span>
              <span id="claude-email">Connected</span>
            </div>
          </div>
          <p class="hint" style="font-size: 0.75rem; color: #f90;">Note: May have restrictions</p>
        </div>
      </div>

      <div class="or-divider">
        <span>OR use API key</span>
      </div>

      <div class="form-group">
        <label for="gemini-key">Google AI Studio API Key (fallback)</label>
        <input type="password" id="gemini-key" placeholder="AIza..." autocomplete="off">
        <p class="hint">
          <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener">Get a free API key</a>
          - Use this if you don't have a Gemini subscription.
        </p>
      </div>

      <div class="form-group">
        <label for="temperature">Creativity Level: <span id="temp-value">0.7</span></label>
        <input type="range" id="temperature" min="0.1" max="1.0" step="0.1" value="0.7">
        <div class="range-labels">
          <span>Conservative</span>
          <span>Creative</span>
        </div>
      </div>
    </section>

    <!-- Step 3: Install -->
    <section id="step3" class="step">
      <div class="step-header">
        <span class="step-number">3</span>
        <h2>Install Addon</h2>
      </div>
      <p class="step-description">
        Click the button below to install Sannsvar in Stremio.
      </p>

      <div class="install-actions">
        <a id="install-link" href="#" class="btn primary large">
          Install in Stremio
        </a>
        <button id="btn-copy-url" class="btn secondary">
          Copy URL
        </button>
      </div>

      <div class="url-preview">
        <code id="addon-url">Configure above to generate URL</code>
      </div>

      <div class="warning-box">
        <strong>Security Note:</strong> Your credentials are encoded in the URL.
        Do not share this URL with others.
      </div>
    </section>

    <footer>
      <p>Sannsvar - Powered by your AI subscriptions</p>
    </footer>
  </div>

  <script>
    // Configuration state
    const config = {
      traktAccessToken: '',
      traktRefreshToken: '',
      geminiApiKey: '',
      temperature: 0.7,
      // OAuth tokens
      googleOAuth: null,
      openaiOAuth: null,
      claudeOAuth: null
    };

    // DOM elements
    const elements = {
      step1: document.getElementById('step1'),
      step2: document.getElementById('step2'),
      step3: document.getElementById('step3'),
      btnStartTrakt: document.getElementById('btn-start-trakt'),
      traktConnect: document.getElementById('trakt-connect'),
      traktAuth: document.getElementById('trakt-auth'),
      traktSuccess: document.getElementById('trakt-success'),
      userCode: document.getElementById('user-code'),
      traktUsername: document.getElementById('trakt-username'),
      // Google OAuth
      googleCard: document.getElementById('google-card'),
      btnGoogleLogin: document.getElementById('btn-google-login'),
      googleConnect: document.getElementById('google-connect'),
      googleSuccess: document.getElementById('google-success'),
      googleEmail: document.getElementById('google-email'),
      // OpenAI OAuth
      openaiCard: document.getElementById('openai-card'),
      btnOpenaiLogin: document.getElementById('btn-openai-login'),
      openaiConnect: document.getElementById('openai-connect'),
      openaiSuccess: document.getElementById('openai-success'),
      openaiEmail: document.getElementById('openai-email'),
      // Claude OAuth
      claudeCard: document.getElementById('claude-card'),
      btnClaudeLogin: document.getElementById('btn-claude-login'),
      claudeConnect: document.getElementById('claude-connect'),
      claudeSuccess: document.getElementById('claude-success'),
      claudeEmail: document.getElementById('claude-email'),
      // API key fallback
      geminiKey: document.getElementById('gemini-key'),
      temperature: document.getElementById('temperature'),
      tempValue: document.getElementById('temp-value'),
      installLink: document.getElementById('install-link'),
      btnCopyUrl: document.getElementById('btn-copy-url'),
      addonUrl: document.getElementById('addon-url')
    };

    // Trakt API configuration (will be loaded from server)
    let traktClientId = '';

    // Load Trakt client ID from server
    async function loadTraktConfig() {
      try {
        const response = await fetch('/api/trakt-config');
        const data = await response.json();
        traktClientId = data.clientId;
      } catch (error) {
        console.error('Failed to load Trakt config:', error);
      }
    }

    // Start Trakt device code flow
    async function startTraktAuth() {
      if (!traktClientId) {
        alert('Trakt configuration not loaded. Please refresh.');
        return;
      }

      elements.traktConnect.classList.add('hidden');
      elements.traktAuth.classList.remove('hidden');

      try {
        const response = await fetch('https://api.trakt.tv/oauth/device/code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'trakt-api-key': traktClientId,
            'trakt-api-version': '2'
          },
          body: JSON.stringify({ client_id: traktClientId })
        });

        if (!response.ok) {
          throw new Error('Failed to get device code');
        }

        const data = await response.json();
        elements.userCode.textContent = data.user_code;

        // Start polling for token
        pollForToken(data.device_code, data.interval * 1000, data.expires_in * 1000);
      } catch (error) {
        console.error('Trakt auth error:', error);
        elements.traktAuth.classList.add('hidden');
        elements.traktConnect.classList.remove('hidden');
        alert('Failed to start Trakt authorization. Please try again.');
      }
    }

    // Poll for Trakt token
    async function pollForToken(deviceCode, interval, timeout) {
      const startTime = Date.now();

      const poll = async () => {
        if (Date.now() - startTime > timeout) {
          alert('Authorization timed out. Please try again.');
          elements.traktAuth.classList.add('hidden');
          elements.traktConnect.classList.remove('hidden');
          return;
        }

        try {
          const response = await fetch('/api/trakt-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ device_code: deviceCode })
          });

          if (response.status === 400) {
            setTimeout(poll, interval);
            return;
          }

          if (!response.ok) {
            throw new Error('Token request failed');
          }

          const data = await response.json();
          config.traktAccessToken = data.access_token;
          config.traktRefreshToken = data.refresh_token;

          elements.traktAuth.classList.add('hidden');
          elements.traktSuccess.classList.remove('hidden');
          elements.traktUsername.textContent = data.username || 'Connected';

          activateStep(2);
        } catch (error) {
          console.error('Token poll error:', error);
          setTimeout(poll, interval);
        }
      };

      poll();
    }

    // Start Google OAuth flow
    async function startGoogleAuth() {
      try {
        const response = await fetch('/api/google-auth-url');
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to get auth URL');
        }

        const data = await response.json();

        // Open OAuth popup
        const width = 500;
        const height = 600;
        const left = (window.innerWidth - width) / 2 + window.screenX;
        const top = (window.innerHeight - height) / 2 + window.screenY;

        window.open(
          data.authUrl,
          'google-oauth',
          `width=${width},height=${height},left=${left},top=${top}`
        );
      } catch (error) {
        console.error('Google auth error:', error);
        alert('Failed to start Google authorization: ' + error.message);
      }
    }

    // Start OpenAI OAuth flow
    async function startOpenAIAuth() {
      try {
        const response = await fetch('/api/openai-auth-url');
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to get auth URL');
        }

        const data = await response.json();

        // Open OAuth popup
        const width = 500;
        const height = 600;
        const left = (window.innerWidth - width) / 2 + window.screenX;
        const top = (window.innerHeight - height) / 2 + window.screenY;

        window.open(
          data.authUrl,
          'openai-oauth',
          `width=${width},height=${height},left=${left},top=${top}`
        );
      } catch (error) {
        console.error('OpenAI auth error:', error);
        alert('Failed to start OpenAI authorization: ' + error.message);
      }
    }

    // Start Claude OAuth flow
    async function startClaudeAuth() {
      try {
        const response = await fetch('/api/claude-auth-url');
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to get auth URL');
        }

        const data = await response.json();

        // Open OAuth popup
        const width = 500;
        const height = 600;
        const left = (window.innerWidth - width) / 2 + window.screenX;
        const top = (window.innerHeight - height) / 2 + window.screenY;

        window.open(
          data.authUrl,
          'claude-oauth',
          `width=${width},height=${height},left=${left},top=${top}`
        );
      } catch (error) {
        console.error('Claude auth error:', error);
        alert('Failed to start Claude authorization: ' + error.message);
      }
    }

    // Handle OAuth callback messages
    window.addEventListener('message', (event) => {
      // Google OAuth
      if (event.data.type === 'google-oauth-success') {
        config.googleOAuth = event.data.tokens;

        // Update UI
        elements.googleConnect.classList.add('hidden');
        elements.googleSuccess.classList.remove('hidden');
        elements.googleCard.classList.add('connected');
        elements.googleEmail.textContent = event.data.tokens.email || 'Connected';

        activateStep(3);
        updateInstallUrl();
      } else if (event.data.type === 'google-oauth-error') {
        alert('Google authorization failed: ' + event.data.error);
      }

      // OpenAI OAuth
      if (event.data.type === 'openai-oauth-success') {
        config.openaiOAuth = event.data.tokens;

        // Update UI
        elements.openaiConnect.classList.add('hidden');
        elements.openaiSuccess.classList.remove('hidden');
        elements.openaiCard.classList.add('connected');
        elements.openaiEmail.textContent = event.data.tokens.email || 'Connected';

        activateStep(3);
        updateInstallUrl();
      } else if (event.data.type === 'openai-oauth-error') {
        alert('OpenAI authorization failed: ' + event.data.error);
      }

      // Claude OAuth
      if (event.data.type === 'claude-oauth-success') {
        config.claudeOAuth = event.data.tokens;

        // Update UI
        elements.claudeConnect.classList.add('hidden');
        elements.claudeSuccess.classList.remove('hidden');
        elements.claudeCard.classList.add('connected');
        elements.claudeEmail.textContent = event.data.tokens.email || 'Connected';

        activateStep(3);
        updateInstallUrl();
      } else if (event.data.type === 'claude-oauth-error') {
        alert('Claude authorization failed: ' + event.data.error);
      }
    });

    // Activate a step
    function activateStep(stepNum) {
      document.querySelectorAll('.step').forEach((step, index) => {
        if (index < stepNum) {
          step.classList.add('completed');
        }
        step.classList.toggle('active', index === stepNum - 1 || index < stepNum);
      });

      updateInstallUrl();
    }

    // Check if we have valid AI credentials
    function hasAICredentials() {
      return config.googleOAuth || config.openaiOAuth || config.claudeOAuth || config.geminiApiKey;
    }

    // Generate addon URL
    function updateInstallUrl() {
      // Only AI credentials required - Trakt is optional
      if (!hasAICredentials()) {
        elements.addonUrl.textContent = 'Connect an AI provider to generate URL';
        elements.installLink.classList.add('disabled');
        elements.installLink.href = '#';
        return;
      }

      const configObj = {
        temperature: config.temperature,
        traktAccessToken: config.traktAccessToken,
        traktRefreshToken: config.traktRefreshToken
      };

      // Add OAuth tokens if present
      if (config.googleOAuth) {
        configObj.googleOAuth = config.googleOAuth;
      }
      if (config.openaiOAuth) {
        configObj.openaiOAuth = config.openaiOAuth;
      }
      if (config.claudeOAuth) {
        configObj.claudeOAuth = config.claudeOAuth;
      }

      // Add API key as fallback
      if (config.geminiApiKey) {
        configObj.geminiApiKey = config.geminiApiKey;
      }

      const encoded = btoa(JSON.stringify(configObj))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');

      const baseUrl = window.location.origin;
      const addonUrl = `${baseUrl}/${encoded}/manifest.json`;
      const stremioUrl = `stremio://${window.location.host}/${encoded}/manifest.json`;

      elements.addonUrl.textContent = addonUrl;
      elements.installLink.href = stremioUrl;
      elements.installLink.classList.remove('disabled');
    }

    // Skip Trakt and go directly to AI providers
    function skipTrakt() {
      elements.traktConnect.classList.add('hidden');
      const skipMsg = document.createElement('div');
      skipMsg.className = 'success-message';
      skipMsg.innerHTML = '<span class="icon" style="color: #888;">âŠ˜</span> <span style="color: #888;">Skipped - recommendations will be generic</span>';
      elements.step1.querySelector('.step-description').after(skipMsg);
      activateStep(2);
    }

    // Event listeners
    elements.btnStartTrakt.addEventListener('click', startTraktAuth);
    document.getElementById('btn-skip-trakt').addEventListener('click', skipTrakt);
    elements.btnGoogleLogin.addEventListener('click', startGoogleAuth);
    elements.btnOpenaiLogin.addEventListener('click', startOpenAIAuth);
    elements.btnClaudeLogin.addEventListener('click', startClaudeAuth);

    elements.geminiKey.addEventListener('input', (e) => {
      config.geminiApiKey = e.target.value.trim();
      if (config.geminiApiKey) {
        activateStep(3);
      }
      updateInstallUrl();
    });

    elements.temperature.addEventListener('input', (e) => {
      config.temperature = parseFloat(e.target.value);
      elements.tempValue.textContent = config.temperature.toFixed(1);
      updateInstallUrl();
    });

    elements.btnCopyUrl.addEventListener('click', async () => {
      const url = elements.addonUrl.textContent;
      if (url.startsWith('http')) {
        await navigator.clipboard.writeText(url);
        elements.btnCopyUrl.textContent = 'Copied!';
        setTimeout(() => {
          elements.btnCopyUrl.textContent = 'Copy URL';
        }, 2000);
      }
    });

    // Initialize
    loadTraktConfig();
  </script>
</body>
</html>
